---
layout: post
title: ã€è¯‘ã€‘ç”¨Javaåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªåŒºå—é“¾-part2:å¯äº¤æ˜“
categories: åŒºå—é“¾
description: åŒºå—é“¾
keywords: åŒºå—é“¾
---
> åŒºå—é“¾æ˜¯åˆ†å¸ƒå¼æ•°æ®å­˜å‚¨ã€ç‚¹å¯¹ç‚¹ä¼ è¾“ã€å…±è¯†æœºåˆ¶ã€åŠ å¯†ç®—æ³•ç­‰è®¡ç®—æœºæŠ€æœ¯çš„æ–°å‹åº”ç”¨æ¨¡å¼ã€‚æ‰€è°“å…±è¯†æœºåˆ¶æ˜¯åŒºå—é“¾ç³»ç»Ÿä¸­å®ç°ä¸åŒèŠ‚ç‚¹ä¹‹é—´å»ºç«‹ä¿¡ä»»ã€è·å–æƒç›Šçš„æ•°å­¦ç®—æ³•  ã€‚

## å‰è¨€
æœ¬ç³»åˆ—æ•™ç¨‹æ—¨åœ¨å¸®åŠ©ä½ äº†è§£å¦‚ä½•å¼€å‘åŒºå—é“¾æŠ€æœ¯ã€‚[ã€è¯‘ã€‘ç”¨Javaåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªåŒºå—é“¾-part2](https://longfeizheng.github.io/2018/03/10/%E7%94%A8Java%E5%88%9B%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E9%93%BE-part1/)

**æœ¬ç« ç›®æ ‡**

- åˆ›å»ºä¸€ä¸ªç®€å•çš„é’±åŒ…ã€‚
- ä½¿ç”¨æˆ‘ä»¬çš„åŒºå—é“¾å‘é€å¸¦ç­¾åçš„äº¤æ˜“ã€‚
- æ„Ÿè§‰å¾ˆåŠ

**è¿™æ ·æˆ‘ä»¬å°±æœ‰è‡ªå·±çš„åŠ å¯†è´§å¸**

*å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œåˆ›å»ºçš„åŒºå—é“¾å¹¶ä¸æ˜¯åŠŸèƒ½å®Œå…¨çš„å®Œå…¨é€‚åˆåº”ç”¨ä¸ç”Ÿäº§çš„åŒºå—é“¾ï¼Œç›¸ååªæ˜¯ä¸ºäº†å¸®åŠ©ä½ æ›´å¥½çš„ç†è§£åŒºå—é“¾çš„æ¦‚å¿µã€‚*

[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai05.gif](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai05.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai05.gif")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai05.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai05.gif")
> åˆ«æ‹…å¿ƒï¼Œè¿™å®é™…ä¸Šæ˜¯å¾ˆç®€å•çš„ï¼Œä½†æ¯”ä¸Šä¸€ä¸ªæ•™ç¨‹è¦é•¿!

åœ¨ä¸Šè¡£ç« èŠ‚[ã€è¯‘ã€‘ç”¨Javaåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªåŒºå—é“¾-part2](https://longfeizheng.github.io/2018/03/10/%E7%94%A8Java%E5%88%9B%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%8C%BA%E5%9D%97%E9%93%BE-part1/)ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„åŒºå—é“¾ï¼Œä½†åœ¨åŒºå—é“¾ä¸­å­˜æ”¾çš„æ˜¯ä¸€äº›æ— ç”¨çš„ä¿¡æ¯ã€‚ä»Šå¤©æˆ‘ä»¬å°†ç”¨äº¤æ˜“å–ä»£è¿™äº›ä¿¡æ¯ï¼ˆæˆ‘ä»¬çš„åŒºå—å°†èƒ½å¤Ÿä¿å­˜å¤šä¸ªäº¤æ˜“ï¼‰ï¼Œå…è®¸æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªéå¸¸ç®€å•çš„åŠ å¯†è´§å¸,æˆ‘ä»¬çš„è´§å¸åå­—`NoobCoin`ã€‚

- æœ¬æ•™ç¨‹æ˜¯åœ¨ä¸Šä¸€è¾¹åŸºç¡€ä¸Šå®ç°çš„
- å¯¼å…¥[ bounceycastle](https://www.bouncycastle.org/latest_releases.html)å’Œ`GSON`


### å‡†å¤‡ä¸€ä¸ªé’±åŒ…

åœ¨åŠ å¯†è´§å¸ä¸­ï¼Œåœ¨åŒºå—é“¾ä½œä¸ºäº¤æ˜“æ—¶ï¼Œè´§å¸æ‰€æœ‰æƒå¯ä»¥è¿›è¡Œè½¬ç§»ï¼Œæ¯ä¸ªå‚ä¸è€…éƒ½æœ‰ä¸€ä¸ªè‡ªå·±ç§æœ‰çš„åœ°å€æ¥å‘é€æˆ–è€…æ˜¯æ”¶å–è´§å¸ã€‚ï¼Œé’±åŒ…å¯ä»¥å­˜å‚¨è¿™äº›åœ°å€ã€‚å› æ­¤é’±åŒ…å°±æ˜¯å¯ä»¥åœ¨åŒºå—é“¾ä¸Šè¿›è¡Œæ–°äº¤æ˜“çš„è½¯ä»¶ã€‚

[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png")
> Donâ€™t worry about the information on the transaction, that will be explained soon

è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé’±åŒ…ç±»æ¥ä¿å­˜å…¬é’¥å’Œç§é’¥:

```java
package noobchain;
import java.security.*;

public class Wallet {
	public PrivateKey privateKey;
	public PublicKey publicKey;
}
```


å…¬é’¥å’Œç§é’¥ç©¶ç«Ÿæ˜¯èµ·åˆ°ä»€ä¹ˆä½œç”¨å‘¢ï¼Œå…¶å®å…¬é’¥çš„ä½œç”¨å°±æ˜¯åœ°å€ï¼Œä½ å¯ä»¥åˆ†äº«ä½ çš„å…¬é’¥ç»™åˆ«äººä»¥æ­¤æ¥è·å–ä»˜æ¬¾ï¼Œè€Œä½ çš„ç§é’¥çš„ä½œç”¨æ˜¯ä¸ºäº†å¯¹äº¤æ˜“è¿›è¡Œç­¾åï¼Œè¿™æ ·å…¶ä»–äººå°±ä¸å¯ä»¥èŠ±è´¹ä½ çš„é‡‘é¢é™¤éå®ƒæ‹¥æœ‰ä½ çš„ç§é’¥ï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸ªäººè€Œè¨€æˆ‘ä»¬å¿…é¡»ä¿æŠ¤å¥½æˆ‘ä»¬çš„ç§é’¥ï¼Œä¸èƒ½é€éœ²æˆ‘ä»¬çš„ç§é’¥ä¿¡æ¯ç»™å…¶ä»–äººã€‚åŒæ—¶åœ¨æˆ‘ä»¬è¿›è¡Œäº¤æ˜“çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿä¼šåŒæ—¶å‘é€æˆ‘ä»¬çš„å…¬é’¥ç”±æ­¤æ¥éªŒè¯æˆ‘ä»¬çš„ç­¾åæ˜¯æœ‰æ•ˆçš„è€Œä¸”æ²¡æœ‰æ•°æ®è¢«ç¯¡æ”¹ã€‚


æˆ‘ä»¬åœ¨å¯†é’¥å¯¹`KeyPair`ç”Ÿæˆç§æœ‰å’Œå…¬é’¥ã€‚æˆ‘ä»¬å°†ä½¿ç”¨[æ¤­åœ†æ›²çº¿åŠ å¯†](https://en.wikipedia.org/wiki/Elliptic-curve_cryptography)æ¥ç”Ÿæˆæˆ‘ä»¬çš„å¯†é’¥å¯¹`KeyPair`ã€‚è®©æˆ‘ä»¬å°†`generateKeyPair()`æ–¹æ³•æ·»åŠ åˆ°æˆ‘ä»¬çš„é’±åŒ…ç±»ä¸­ï¼Œå¹¶åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨å®ƒ:




[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai02.png")
> ç§é’¥ç”¨äºç­¾ç½²æˆ‘ä»¬ä¸æƒ³è¢«ç¯¡æ”¹çš„æ•°æ®ã€‚å…¬é’¥ç”¨äºéªŒè¯ç­¾åã€‚

```java
package noobchain;
import java.security.*;

public class Wallet {
	
	public PrivateKey privateKey;
	public PublicKey publicKey;
	
	public Wallet(){
		generateKeyPair();	
	}
		
	public void generateKeyPair() {
		try {
			KeyPairGenerator keyGen = KeyPairGenerator.getInstance("ECDSA","BC");
			SecureRandom random = SecureRandom.getInstance("SHA1PRNG");
			ECGenParameterSpec ecSpec = new ECGenParameterSpec("prime192v1");
			// Initialize the key generator and generate a KeyPair
			keyGen.initialize(ecSpec, random);   //256 bytes provides an acceptable security level
	        	KeyPair keyPair = keyGen.generateKeyPair();
	        	// Set the public and private keys from the keyPair
	        	privateKey = keyPair.getPrivate();
	        	publicKey = keyPair.getPublic();
		}catch(Exception e) {
			throw new RuntimeException(e);
		}
	}
	
}
```
> ä½ ä¸éœ€è¦å®Œå…¨ç†è§£æ¤­åœ†æ›²çº¿åŠ å¯†ç®—æ³•çš„æ ¸å¿ƒé€»è¾‘ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œä½ åªéœ€è¦å®ƒæ˜¯ç”¨æ¥åˆ›å»ºå…¬é’¥å’Œç§é’¥ï¼Œä»¥åŠå…¬é’¥å’Œç§é’¥åˆ†åˆ«æ‰€èµ·åˆ°çš„ä½œç”¨æ˜¯ä»€ä¹ˆå°±å¯ä»¥äº†ã€‚

ç°åœ¨æˆ‘ä»¬å·²ç»åˆäº†é’±åŒ…ç±»çš„å¤§æ¦‚æ¡†æ¶ï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹äº¤æ˜“ç±»ã€‚

[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai06.gif](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai06.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai06.gif")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai06.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai06.gif")


### äº¤æ˜“å’Œæ•°å­—ç­¾å

æ¯ç¬”äº¤æ˜“å°†æºå¸¦ä¸€å®šä»¥ä¸‹ä¿¡æ¯ï¼š

1. èµ„é‡‘ä»˜æ¬¾äººçš„å…¬åŒ™ä¿¡æ¯ã€‚
2. èµ„é‡‘æ”¶æ¬¾äººçš„å…¬åŒ™ä¿¡æ¯ã€‚
3. è¢«è½¬ç§»èµ„é‡‘çš„é‡‘é¢ã€‚
3. è¾“å…¥ï¼Œå®ƒæ˜¯å¯¹ä»¥å‰çš„äº¤æ˜“çš„å¼•ç”¨ï¼Œè¯æ˜å‘é€è€…æœ‰èµ„é‡‘å‘é€ã€‚
4. è¾“å‡ºï¼Œæ˜¾ç¤ºäº¤æ˜“ä¸­æ”¶æ¬¾æ–¹ç›¸å…³åœ°å€æ•°é‡ã€‚(è¿™äº›è¾“å‡ºè¢«å¼•ç”¨ä¸ºæ–°äº¤æ˜“çš„è¾“å…¥)
5. ä¸€ä¸ªåŠ å¯†ç­¾åï¼Œè¯æ˜è¯¥äº¤æ˜“æ˜¯ç”±åœ°å€çš„å‘é€è€…æ˜¯å‘é€çš„ï¼Œå¹¶ä¸”æ•°æ®æ²¡æœ‰è¢«æ›´æ”¹ã€‚(é˜»æ­¢ç¬¬ä¸‰æ–¹æœºæ„æ›´æ”¹å‘é€çš„æ•°é‡)

è®©æˆ‘ä»¬åˆ›å»ºè¿™ä¸ªæ–°çš„äº¤æ˜“ç±»ï¼š

```java
import java.security.*;
import java.util.ArrayList;

public class Transaction {
	
	public String transactionId; // this is also the hash of the transaction.
	public PublicKey sender; // senders address/public key.
	public PublicKey reciepient; // Recipients address/public key.
	public float value;
	public byte[] signature; // this is to prevent anybody else from spending funds in our wallet.
	
	public ArrayList<TransactionInput> inputs = new ArrayList<TransactionInput>();
	public ArrayList<TransactionOutput> outputs = new ArrayList<TransactionOutput>();
	
	private static int sequence = 0; // a rough count of how many transactions have been generated. 
	
	// Constructor: 
	public Transaction(PublicKey from, PublicKey to, float value,  ArrayList<TransactionInput> inputs) {
		this.sender = from;
		this.reciepient = to;
		this.value = value;
		this.inputs = inputs;
	}
	
	// This Calculates the transaction hash (which will be used as its Id)
	private String calulateHash() {
		sequence++; //increase the sequence to avoid 2 identical transactions having the same hash
		return StringUtil.applySha256(
				StringUtil.getStringFromKey(sender) +
				StringUtil.getStringFromKey(reciepient) +
				Float.toString(value) + sequence
				);
	}
}
```

æˆ‘ä»¬è¿˜åº”è¯¥åˆ›å»ºç©ºçš„`transactioninput`å’Œ`transactionoutput`ç±»ï¼Œä¸è¦æ‹…å¿ƒæˆ‘ä»¬å¯ä»¥åœ¨åé¢å¡«å†™å®ƒä»¬ã€‚

æˆ‘ä»¬çš„äº¤æ˜“ç±»è¿˜å°†åŒ…å«ç”Ÿæˆ/éªŒè¯ç­¾åå’ŒéªŒè¯äº¤æ˜“çš„ç›¸å…³æ–¹æ³•ï¼Œé‚£ä¹ˆç­¾åçš„æ„å›¾æ˜¯ä»€ä¹ˆï¼Ÿç­¾ååœ¨æˆ‘ä»¬çš„åŒºå—é“¾ä¸­æ‰§è¡Œäº†ä¸¤ä¸ªéå¸¸é‡è¦çš„ä»»åŠ¡ï¼šç¬¬ä¸€ï¼Œç­¾åç”¨æ¥ä¿è¯åªæœ‰è´§å¸çš„æ‹¥æœ‰è€…æ‰å¯ä»¥ç”¨æ¥å‘é€è‡ªå·±çš„è´§å¸ï¼Œç¬¬äºŒï¼Œç­¾åç”¨æ¥é˜»æ­¢å…¶ä»–äººè¯•å›¾ç¯¡æ”¹æäº¤çš„äº¤æ˜“ã€‚

**å³ç§é’¥è¢«ç”¨æ¥ç­¾åæ•°æ®ï¼Œè€Œå…¬é’¥ç”¨æ¥éªŒè¯å…¶å®Œæ•´æ€§ã€‚**

> ä¸¾ä¸ªä¾‹å­ï¼šBob æƒ³è¦å‘é€2ä¸ªåŠ å¯†è´§å¸ç»™Sallyï¼Œä»–ä»¬ç”¨å„è‡ªçš„é’±åŒ…åˆ›å»ºäº†äº¤æ˜“ï¼Œå¹¶æäº¤åˆ°å…¨ç½‘çš„åŒºå—é“¾ä¸­ä½œä¸ºä¸€ä¸ªæ–°çš„åŒºå—ï¼Œä¸€ä¸ªæŒ–çŸ¿è€…è¯•å›¾ç¯¡æ”¹æ¥å—è€…æŠŠ2ä¸ªåŠ å¯†è´§å¸ç»™Johnï¼Œä½†æ˜¯å¹¸è¿çš„äº‹ï¼ŒBobåœ¨äº¤æ˜“æ•°æ®ä¸­å·²ç»ç”¨ç§é’¥è¿›è¡Œäº†ç­¾åï¼Œè¿™å°±å…è®¸äº†å…¨ç½‘ä¸­çš„ä»»ä½•èŠ‚ç‚¹ä½¿ç”¨å°æ˜çš„å…¬åŒ™è¿›è¡ŒéªŒè¯æ•°æ®æ˜¯å¦å·²ç»è¢«ç¯¡æ”¹ï¼ˆå› ä¸ºæ²¡æœ‰å…¶ä»–äººçš„å…¬é’¥å¯ä»¥ç”¨æ¥éªŒè¯å°æ˜å‘å‡ºçš„è¿™ç¬”äº¤æ˜“ï¼‰ã€‚

ä»å‰é¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ç­¾åå°†æ˜¯ä¸€å †å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–¹æ³•æ¥ç”Ÿæˆå®ƒä»¬ã€‚é¦–å…ˆæˆ‘ä»¬åœ¨`StringUtil`ç±»ä¸­åˆ›å»ºäº§ç”Ÿç­¾åçš„æ–¹æ³•ã€‚

```java
public static byte[] applyECDSASig(PrivateKey privateKey, String input) {
		Signature dsa;
		byte[] output = new byte[0];
		try {
			dsa = Signature.getInstance("ECDSA", "BC");
			dsa.initSign(privateKey);
			byte[] strByte = input.getBytes();
			dsa.update(strByte);
			byte[] realSig = dsa.sign();
			output = realSig;
		} catch (Exception e) {
			throw new RuntimeException(e);
		}
		return output;
	}
	
	//Verifies a String signature 
	public static boolean verifyECDSASig(PublicKey publicKey, String data, byte[] signature) {
		try {
			Signature ecdsaVerify = Signature.getInstance("ECDSA", "BC");
			ecdsaVerify.initVerify(publicKey);
			ecdsaVerify.update(data.getBytes());
			return ecdsaVerify.verify(signature);
		}catch(Exception e) {
			throw new RuntimeException(e);
		}
	}

	public static String getStringFromKey(Key key) {
		return Base64.getEncoder().encodeToString(key.getEncoded());
	}
```
> ä¸ç”¨æ‹…å¿ƒä½ ä¸èƒ½ç†è§£è¿™äº›æ–¹æ³•çš„å†…å®¹ï¼Œä½ æ‰€éœ€è¦çŸ¥é“çš„å°±æ˜¯`applyECDSASig`æ–¹æ³•çš„è¾“å…¥å‚æ•°ä¸ºä»˜æ¬¾äººçš„ç§é’¥å’Œéœ€è¦åŠ å¯†çš„æ•°æ®ä¿¡æ¯ï¼Œç­¾ååè¿”å›å­—èŠ‚æ•°ç»„ã€‚è€Œ`verifyECDSASig`æ–¹æ³•çš„è¾“å…¥å‚æ•°ä¸ºå…¬é’¥ã€åŠ å¯†çš„æ•°æ®å’Œç­¾åï¼Œè°ƒç”¨è¯¥æ–¹æ³•åè¿”å›trueæˆ–falseæ¥è¯´æ˜ç­¾åæ˜¯å¦æ˜¯æœ‰æ•ˆçš„ã€‚`getStringFromKey`è¿”å›ä»»ä½•`key`çš„ç¼–ç å­—ç¬¦ä¸²

è®©æˆ‘ä»¬ä½¿ç”¨ç­¾åçš„æ–¹æ³•åœ¨äº¤æ˜“ç±»ä¸­ï¼Œå¢åŠ `generatesiganature()` å’Œ `varifiysignature()`æ–¹æ³•ï¼š

```java
//Signs all the data we dont wish to be tampered with.
public void generateSignature(PrivateKey privateKey) {
	String data = StringUtil.getStringFromKey(sender) + StringUtil.getStringFromKey(reciepient) + Float.toString(value)	;
	signature = StringUtil.applyECDSASig(privateKey,data);		
}
//Verifies the data we signed hasnt been tampered with
public boolean verifiySignature() {
	String data = StringUtil.getStringFromKey(sender) + StringUtil.getStringFromKey(reciepient) + Float.toString(value)	;
	return StringUtil.verifyECDSASig(sender, data, signature);
}
```
> åœ¨ç°å®ä¸­ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ç­¾åæ›´å¤šä¿¡æ¯ï¼Œä¾‹å¦‚ä½¿ç”¨çš„è¾“å‡º/è¾“å…¥å’Œ/æˆ–æ—¶é—´æˆ³ï¼ˆç°åœ¨æˆ‘ä»¬åªæ˜¯ç­¾åæœ€ä½é™åº¦çš„ä¿¡æ¯ï¼‰

ç­¾åå°†ç”±çŸ¿å·¥éªŒè¯ï¼Œåªæœ‰ç­¾åéªŒè¯æˆåŠŸåäº¤æ˜“æ‰èƒ½è¢«æ·»åŠ åˆ°åŒºå—ä¸­å»ã€‚

[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai07.gif](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai07.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai07.gif")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai07.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai07.gif")
> å½“æˆ‘ä»¬æ£€æŸ¥åŒºå—é“¾çš„æœ‰æ•ˆæ€§æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ£€æŸ¥ç­¾å

### æµ‹è¯•é’±åŒ…å’Œç­¾å

ç°åœ¨æˆ‘ä»¬ç®€å•çš„è¿›è¡Œä¸€äº›æµ‹è¯•ï¼Œåœ¨ä¸»æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸€äº›æ–°çš„å˜é‡ä¹Ÿæ›¿æ¢äº†æˆ‘ä»¬ä¹‹å‰åœ¨ä¸»æ–¹æ³•ä¸­çš„ä¸€äº›å†…å®¹ã€‚

```java
import java.security.Security;
import java.util.ArrayList;
import java.util.Base64;
import com.google.gson.GsonBuilder;

public class NoobChain {
	
	public static ArrayList<Block> blockchain = new ArrayList<Block>();
	public static int difficulty = 5;
	public static Wallet walletA;
	public static Wallet walletB;

	public static void main(String[] args) {	
		//Setup Bouncey castle as a Security Provider
		Security.addProvider(new org.bouncycastle.jce.provider.BouncyCastleProvider()); 
		//Create the new wallets
		walletA = new Wallet();
		walletB = new Wallet();
		//Test public and private keys
		System.out.println("Private and public keys:");
		System.out.println(StringUtil.getStringFromKey(walletA.privateKey));
		System.out.println(StringUtil.getStringFromKey(walletA.publicKey));
		//Create a test transaction from WalletA to walletB 
		Transaction transaction = new Transaction(walletA.publicKey, walletB.publicKey, 5, null);
		transaction.generateSignature(walletA.privateKey);
		//Verify the signature works and verify it from the public key
		System.out.println("Is signature verified");
		System.out.println(transaction.verifiySignature());
		
	}
```
> ç¡®å®šè¦æ·»åŠ `bounceycastle`ä¾èµ–

æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªé’±åŒ…walletaå’Œwalletbï¼Œç„¶åæ‰“å°äº†walletaçš„ç§é’¥å’Œå…¬é’¥ã€‚ç”Ÿæˆä¸€ä¸ªäº¤æ˜“å¹¶ä½¿ç”¨walletaçš„ç§é’¥å¯¹å…¶è¿›è¡Œç­¾åã€‚

æ‰“å°
```java
Connected to the target VM, address: '127.0.0.1:55757', transport: 'socket'
Private and public keys:
MHsCAQAwEwYHKoZIzj0CAQYIKoZIzj0DAQEEYTBfAgEBBBiJzZiesBnBWwwB+uog+fJX84mx4lPUTUagCgYIKoZIzj0DAQGhNAMyAAQfPzad0zqBUGQAany2rRZE1+2ml5IOCZST8LywjBQT8ux+3UPVbr2u0+LaExxz1WI=
MEkwEwYHKoZIzj0CAQYIKoZIzj0DAQEDMgAEHz82ndM6gVBkAGp8tq0WRNftppeSDgmUk/C8sIwUE/Lsft1D1W69rtPi2hMcc9Vi
Is signature verified
true
```

æ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ›å»ºå¹¶éªŒè¯è¾“å…¥å’Œè¾“å‡ºï¼Œå¹¶æŠŠäº¤æ˜“ä¿å­˜åˆ°åŒºå—é“¾ä¸­å»ã€‚

### è¾“å…¥å’Œè¾“å‡º 1ï¼šå¦‚ä½•éªŒè¯è´§å¸æ˜¯ä½ çš„

å¦‚æœä½ æ‹¥æœ‰1æ¯”ç‰¹å¸ï¼Œä½ å¿…é¡»å‰é¢å°±å¾—æ¥æ”¶1æ¯”ç‰¹å¸ã€‚æ¯”ç‰¹å¸çš„è´¦æœ¬ä¸ä¼šåœ¨ä½ çš„è´¦æˆ·ä¸­å¢åŠ ä¸€ä¸ªæ¯”ç‰¹å¸ä¹Ÿä¸ä¼šä»å‘é€è€…é‚£é‡Œå‡å»ä¸€ä¸ªæ¯”ç‰¹å¸ï¼Œå‘é€è€…åªèƒ½æŒ‡å‘ä»–/å¥¹ä¹‹å‰æ”¶åˆ°è¿‡ä¸€ä¸ªæ¯”ç‰¹å¸ï¼Œæ‰€ä»¥ä¸€ä¸ªäº¤æ˜“è¾“å‡ºè¢«åˆ›å»ºç”¨æ¥æ˜¾ç¤ºä¸€ä¸ªæ¯”ç‰¹å¸å‘é€ç»™ä½ çš„åœ°å€ï¼ˆäº¤æ˜“çš„è¾“å…¥æŒ‡å‘å‰ä¸€ä¸ªäº¤æ˜“çš„è¾“å‡ºï¼‰ã€‚

**ä½ çš„é’±åŒ…ä½™é¢æ˜¯æ‰€æœ‰æœªä½¿ç”¨çš„äº¤æ˜“è¾“å‡ºçš„æ€»å’Œ**

ä»è¿™ä¸€ä¸ªç‚¹å‡ºå‘ï¼Œæˆ‘ä»¬ä¼šä¾ç…§æ¯”ç‰¹å¸ä¸­çš„è¯´æ˜ï¼ŒæŠŠæ‰€æœ‰æœªä½¿ç”¨çš„äº¤æ˜“è¾“å‡ºç§°ä¸º[UTXO](http://8btc.com/article-4381-1.html).

åˆ›å»º`TransactionInput` ç±»ï¼š

```java
public class TransactionInput {
	public String transactionOutputId; //Reference to TransactionOutputs -> transactionId
	public TransactionOutput UTXO; //Contains the Unspent transaction output
	
	public TransactionInput(String transactionOutputId) {
		this.transactionOutputId = transactionOutputId;
	}
}
```
> è¿™ä¸ªç±»å°†ç”¨äºå¼•ç”¨å°šæœªä½¿ç”¨çš„`transactionoutput`ã€‚`transactionOutputId`å°†ç”¨äºæŸ¥æ‰¾ç›¸å…³çš„`TransactionOutput`ï¼Œå…è®¸çŸ¿å·¥æ£€æŸ¥æ‚¨çš„æ‰€æœ‰æƒã€‚

åˆ›å»º`TransactionOutputs `ç±»ï¼š

```java
import java.security.PublicKey;

public class TransactionOutput {
	public String id;
	public PublicKey reciepient; //also known as the new owner of these coins.
	public float value; //the amount of coins they own
	public String parentTransactionId; //the id of the transaction this output was created in
	
	//Constructor
	public TransactionOutput(PublicKey reciepient, float value, String parentTransactionId) {
		this.reciepient = reciepient;
		this.value = value;
		this.parentTransactionId = parentTransactionId;
		this.id = StringUtil.applySha256(StringUtil.getStringFromKey(reciepient)+Float.toString(value)+parentTransactionId);
	}
	
	//Check if coin belongs to you
	public boolean isMine(PublicKey publicKey) {
		return (publicKey == reciepient);
	}
	
}
```

äº¤æ˜“è¾“å‡ºç±»å°†æ˜¾ç¤ºä»äº¤æ˜“ä¸­å‘é€ç»™æ¯ä¸€æ–¹çš„æœ€ç»ˆé‡‘é¢ã€‚è¿™äº›ä½œä¸ºæ–°äº¤æ˜“ä¸­çš„è¾“å…¥å‚è€ƒï¼Œä½œä¸ºè¯æ˜ä½ å¯ä»¥å‘é€çš„é‡‘é¢æ•°é‡ã€‚

[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai08.gif](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai08.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai08.gif")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai08.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai08.gif")

### è¾“å…¥å’Œè¾“å‡º 2ï¼šå¤„ç†äº¤æ˜“

åŒºå—é“¾å¯èƒ½ä¼šæ”¶åˆ°å¾ˆå¤šäº¤æ˜“ï¼Œè€ŒåŒºå—é“¾å¯èƒ½ä¼šéå¸¸é•¿ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»æŸ¥æ‰¾å¹¶æ£€æŸ¥å…¶è¾“å…¥ï¼Œæ‰€ä»¥å¯èƒ½éœ€è¦éå¸¸é•¿çš„æ—¶é—´æ¥å¤„ç†æ–°çš„äº¤æ˜“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¿å­˜äº†ä¸€ä¸ªé¢å¤–çš„é›†åˆç§°ä¹‹ä¸ºä¸ºä½¿ç”¨çš„äº¤æ˜“ä½œä¸ºå¯ç”¨çš„è¾“å…¥,æ‰€ä»¥åœ¨ä¸»å‡½æ•°ä¸­å¢åŠ ä¸€ä¸ªé›†åˆç§°ä¸ºUTXOã€‚

```java
public class NoobChain {
	
	public static ArrayList<Block> blockchain = new ArrayList<Block>();
	public static HashMap<String,TransactionOutputs> UTXOs = new HashMap<String,TransactionOutputs>(); //list of all unspent transactions. 
	public static int difficulty = 5;
	public static Wallet walletA;
	public static Wallet walletB;

	public static void main(String[] args) {	
```
> `hashmap`å…è®¸æˆ‘ä»¬ä½¿ç”¨é”®æ¥æŸ¥æ‰¾å€¼ï¼Œä½†æ˜¯æ‚¨éœ€è¦å¯¼å…¥`java.util.hashmap`


é‡ç‚¹æ¥äº†ï¼Œæˆ‘ä»¬åœ¨äº¤æ˜“ç±»ä¸­å¢åŠ ä¸€ä¸ª`processTransaction`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æŠŠä¸€åˆ‡æ”¾åœ¨ä¸€èµ·ç”¨æ¥å¤„ç†äº¤æ˜“ã€‚

```java
//Returns true if new transaction could be created.	
public boolean processTransaction() {
		
		if(verifiySignature() == false) {
			System.out.println("#Transaction Signature failed to verify");
			return false;
		}
				
		//gather transaction inputs (Make sure they are unspent):
		for(TransactionInput i : inputs) {
			i.UTXO = NoobChain.UTXOs.get(i.transactionOutputId);
		}

		//check if transaction is valid:
		if(getInputsValue() < NoobChain.minimumTransaction) {
			System.out.println("#Transaction Inputs to small: " + getInputsValue());
			return false;
		}
		
		//generate transaction outputs:
		float leftOver = getInputsValue() - value; //get value of inputs then the left over change:
		transactionId = calulateHash();
		outputs.add(new TransactionOutput( this.reciepient, value,transactionId)); //send value to recipient
		outputs.add(new TransactionOutput( this.sender, leftOver,transactionId)); //send the left over 'change' back to sender		
				
		//add outputs to Unspent list
		for(TransactionOutput o : outputs) {
			NoobChain.UTXOs.put(o.id , o);
		}
		
		//remove transaction inputs from UTXO lists as spent:
		for(TransactionInput i : inputs) {
			if(i.UTXO == null) continue; //if Transaction can't be found skip it 
			NoobChain.UTXOs.remove(i.UTXO.id);
		}
		
		return true;
	}
	
//returns sum of inputs(UTXOs) values
	public float getInputsValue() {
		float total = 0;
		for(TransactionInput i : inputs) {
			if(i.UTXO == null) continue; //if Transaction can't be found skip it 
			total += i.UTXO.value;
		}
		return total;
	}

//returns sum of outputs:
	public float getOutputsValue() {
		float total = 0;
		for(TransactionOutput o : outputs) {
			total += o.value;
		}
		return total;
	}
```
> æˆ‘ä»¬è¿˜æ·»åŠ äº†`getinputsvalue`æ–¹æ³•

é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬æ‰§è¡Œä¸€äº›æ£€æŸ¥ä»¥ç¡®ä¿äº¤æ˜“æœ‰æ•ˆï¼Œç„¶åæ”¶é›†è¾“å…¥å¹¶ç”Ÿæˆè¾“å‡ºã€‚æœ€é‡è¦çš„æ˜¯ï¼Œæœ€åï¼Œæˆ‘ä»¬æŠ›å¼ƒäº†è¾“å…¥åœ¨æˆ‘ä»¬çš„UTXOåˆ—è¡¨ï¼Œè¿™å°±æ„å‘³ç€ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„äº¤æ˜“è¾“å‡ºå¿…é¡»ä¹‹å‰ä¸€å®šæ˜¯è¾“å…¥ï¼Œæ‰€ä»¥è¾“å…¥çš„å€¼å¿…é¡»è¢«å®Œå…¨ä½¿ç”¨ï¼Œæ‰€ä»¥ä»˜æ¬¾äººå¿…é¡»æ”¹å˜å®ƒä»¬è‡ªèº«çš„é‡‘é¢çŠ¶æ€ã€‚

[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.png](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.png "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.png")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.png "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.png")

> çº¢è‰²ç®­å¤´æ˜¯è¾“å‡ºã€‚è¯·æ³¨æ„ï¼Œç»¿è‰²è¾“å…¥æ˜¯å¯¹ä¹‹å‰è¾“å‡ºçš„å‚è€ƒ

æœ€åè®©æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„walletç±»

-  æœé›†ä½™é¢ï¼ˆé€šè¿‡å¾ªç¯éå†UTXOåˆ—è¡¨æ¥æ£€æŸ¥äº¤æ˜“çš„è¾“å‡ºæ˜¯å¦æ˜¯æˆ‘çš„ï¼‰å¹¶
- åˆ›å»ºäº¤æ˜“

```java
import java.security.*;
import java.security.spec.ECGenParameterSpec;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;

public class Wallet {
	
	public PrivateKey privateKey;
	public PublicKey publicKey;
	
	public HashMap<String,TransactionOutput> UTXOs = new HashMap<String,TransactionOutput>(); //only UTXOs owned by this wallet.
	
	public Wallet() {...
		
	public void generateKeyPair() {...
	
  //returns balance and stores the UTXO's owned by this wallet in this.UTXOs
	public float getBalance() {
		float total = 0;	
        for (Map.Entry<String, TransactionOutput> item: NoobChain.UTXOs.entrySet()){
        	TransactionOutput UTXO = item.getValue();
            if(UTXO.isMine(publicKey)) { //if output belongs to me ( if coins belong to me )
            	UTXOs.put(UTXO.id,UTXO); //add it to our list of unspent transactions.
            	total += UTXO.value ; 
            }
        }  
		return total;
	}
	//Generates and returns a new transaction from this wallet.
	public Transaction sendFunds(PublicKey _recipient,float value ) {
		if(getBalance() < value) { //gather balance and check funds.
			System.out.println("#Not Enough funds to send transaction. Transaction Discarded.");
			return null;
		}
    //create array list of inputs
		ArrayList<TransactionInput> inputs = new ArrayList<TransactionInput>();
    
		float total = 0;
		for (Map.Entry<String, TransactionOutput> item: UTXOs.entrySet()){
			TransactionOutput UTXO = item.getValue();
			total += UTXO.value;
			inputs.add(new TransactionInput(UTXO.id));
			if(total > value) break;
		}
		
		Transaction newTransaction = new Transaction(publicKey, _recipient , value, inputs);
		newTransaction.generateSignature(privateKey);
		
		for(TransactionInput input: inputs){
			UTXOs.remove(input.transactionOutputId);
		}
		return newTransaction;
	}
	
}
```
> ä½ å¯ä»¥éšæ—¶ä¸ºé’±åŒ…æ·»åŠ ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼Œä¾‹å¦‚è®°å½•æ‚¨çš„äº¤æ˜“å†å²è®°å½•ã€‚

### æ·»åŠ äº¤æ˜“åˆ°åŒºå—ä¸­

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªæœ‰æ•ˆçš„äº¤æ˜“ç³»ç»Ÿï¼Œæˆ‘ä»¬éœ€è¦æŠŠäº¤æ˜“åŠ å…¥åˆ°æˆ‘ä»¬çš„åŒºå—é“¾ä¸­ã€‚æˆ‘ä»¬æŠŠäº¤æ˜“åˆ—è¡¨æ›¿æ¢æˆ‘ä»¬å—ä¸­æ— ç”¨çš„æ•°æ®ï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªå•ä¸€çš„åŒºå—ä¸­å¯èƒ½å­˜æ”¾äº†1000ä¸ªäº¤æ˜“ï¼Œè¿™å°±ä¼šå¯¼è‡´å¤§é‡çš„hashè®¡ç®—ï¼Œä¸ç”¨æ‹…å¿ƒåœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†äº¤æ˜“çš„`merkle root`ï¼Œç¨åä½ ä¼šçœ‹åˆ°ã€‚è®©æˆ‘ä»¬å¢åŠ ä¸€ä¸ªå¸®åŠ©æ–¹æ³•æ¥åˆ›å»º`merkle root`åœ¨`StringUtils`ç±»ä¸­ã€‚

åœ¨`StringUtils`ç±»ä¸­åˆ›å»º`getMerkleRoot`æ–¹æ³•

```java
//Tacks in array of transactions and returns a merkle root.
public static String getMerkleRoot(ArrayList<Transaction> transactions) {
		int count = transactions.size();
		ArrayList<String> previousTreeLayer = new ArrayList<String>();
		for(Transaction transaction : transactions) {
			previousTreeLayer.add(transaction.transactionId);
		}
		ArrayList<String> treeLayer = previousTreeLayer;
		while(count > 1) {
			treeLayer = new ArrayList<String>();
			for(int i=1; i < previousTreeLayer.size(); i++) {
				treeLayer.add(applySha256(previousTreeLayer.get(i-1) + previousTreeLayer.get(i)));
			}
			count = treeLayer.size();
			previousTreeLayer = treeLayer;
		}
		String merkleRoot = (treeLayer.size() == 1) ? treeLayer.get(0) : "";
		return merkleRoot;
	}
```
> æˆ‘ä¼šå°½å¿«ç”¨ä¸€ä¸ªå®é™…çš„merklerootå–ä»£è¿™ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯ç°åœ¨ä½¿ç”¨è¿™ä¸ªå¯ä»¥æ­£å¸¸è¿è¡Œ

ä¿®æ¥`Block` ç±»

```java
import java.util.ArrayList;
import java.util.Date;

public class Block {
	
	public String hash;
	public String previousHash; 
	public String merkleRoot;
	public ArrayList<Transaction> transactions = new ArrayList<Transaction>(); //our data will be a simple message.
	public long timeStamp; //as number of milliseconds since 1/1/1970.
	public int nonce;
	
	//Block Constructor.  
	public Block(String previousHash ) {
		this.previousHash = previousHash;
		this.timeStamp = new Date().getTime();
		
		this.hash = calculateHash(); //Making sure we do this after we set the other values.
	}
	
	//Calculate new hash based on blocks contents
	public String calculateHash() {
		String calculatedhash = StringUtil.applySha256( 
				previousHash +
				Long.toString(timeStamp) +
				Integer.toString(nonce) + 
				merkleRoot
				);
		return calculatedhash;
	}
	
	//Increases nonce value until hash target is reached.
	public void mineBlock(int difficulty) {
		merkleRoot = StringUtil.getMerkleRoot(transactions);
		String target = StringUtil.getDificultyString(difficulty); //Create a string with difficulty * "0" 
		while(!hash.substring( 0, difficulty).equals(target)) {
			nonce ++;
			hash = calculateHash();
		}
		System.out.println("Block Mined!!! : " + hash);
	}
	
	//Add transactions to this block
	public boolean addTransaction(Transaction transaction) {
		//process transaction and check if valid, unless block is genesis block then ignore.
		if(transaction == null) return false;		
		if((previousHash != "0")) {
			if((transaction.processTransaction() != true)) {
				System.out.println("Transaction failed to process. Discarded.");
				return false;
			}
		}
		transactions.add(transaction);
		System.out.println("Transaction Successfully added to Block");
		return true;
	}
	
}
```

éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¿˜æ›´æ–°äº†`Block`æ„é€ å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬ä¸å†éœ€è¦ä¼ é€’å­—ç¬¦ä¸²æ•°æ®ï¼Œå¹¶å°†`merkle root`åŒ…å«åœ¨è®¡ç®—å“ˆå¸Œæ–¹æ³•ä¸­ã€‚`addTransaction`æ–¹æ³•ç”¨æ¥å¢åŠ äº¤æ˜“ï¼Œåªæœ‰æ»¡è¶³æ¡ä»¶ä¸‹æ‰å¯ä»¥æˆåŠŸçš„åœ¨åŒºå—ä¸­å¢åŠ äº¤æ˜“ã€‚

æˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªå¯äº¤æ˜“çš„åŒºå—é“¾ã€‚

[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai09.gif](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai09.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai09.gif")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai09.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai09.gif")

### æœ€åçš„æµ‹è¯•

æˆ‘ä»¬åº”è¯¥æµ‹è¯•ä»é’±åŒ…å‘é€è´§å¸ï¼Œæ›´æ–°åŒºå—é“¾å¹¶è¿›è¡Œæœ‰æ•ˆæ€§æ£€æŸ¥ã€‚ä½†é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ç§å°†æ–°ç¡¬å¸å¼•å…¥æ··åˆçš„æ–¹æ³•ã€‚æœ‰å¾ˆå¤šæ–¹æ³•æ¥åˆ›å»ºæ–°çš„ç¡¬å¸ã€‚åœ¨æ¯”ç‰¹å¸åŒºå—é“¾ä¸Šï¼Œæœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥åˆ›é€ æ–°çš„æ¯”ç‰¹å¸:çŸ¿å·¥å¯ä»¥å°†äº¤æ˜“åŒ…æ‹¬åœ¨å†…ï¼Œä½œä¸ºå¯¹æ¯ä¸ªçŸ¿å·¥æŒ–çŸ¿çš„å¥–åŠ±ã€‚ä½†åœ¨è¿™é‡Œæˆ‘ä»¬åªå¸Œæœ›åœ¨åˆ›ä¸–çºªåŒºå—ä¸­é‡Šæ”¾è´§å¸ã€‚å°±åƒæ¯”ç‰¹å¸ä¸­ä¸€ä¸‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„ä¸»å‡½æ•°ä»¥è¾¾åˆ°ä¸‹é¢çš„ç›®çš„ã€‚

1. åˆ›ä¸–çºªåŒºå—å‘å¸ƒ100ä¸ªè´§å¸ç»™walletA
1. ä¸€ä¸ªæ›´æ–°çš„é“¾æœ‰æ•ˆæ€§æ£€æŸ¥ï¼Œè€ƒè™‘åˆ°äº¤æ˜“ã€‚
1. æµ‹è¯•äº¤æ˜“çœ‹æ˜¯å¦ä¸€åˆ‡æ­£å¸¸ã€‚

```java
public class NoobChain {
	
	public static ArrayList<Block> blockchain = new ArrayList<Block>();
	public static HashMap<String,TransactionOutput> UTXOs = new HashMap<String,TransactionOutput>();
	
	public static int difficulty = 3;
	public static float minimumTransaction = 0.1f;
	public static Wallet walletA;
	public static Wallet walletB;
	public static Transaction genesisTransaction;

	public static void main(String[] args) {	
		//add our blocks to the blockchain ArrayList:
		Security.addProvider(new org.bouncycastle.jce.provider.BouncyCastleProvider()); //Setup Bouncey castle as a Security Provider
		
		//Create wallets:
		walletA = new Wallet();
		walletB = new Wallet();		
		Wallet coinbase = new Wallet();
		
		//create genesis transaction, which sends 100 NoobCoin to walletA: 
		genesisTransaction = new Transaction(coinbase.publicKey, walletA.publicKey, 100f, null);
		genesisTransaction.generateSignature(coinbase.privateKey);	 //manually sign the genesis transaction	
		genesisTransaction.transactionId = "0"; //manually set the transaction id
		genesisTransaction.outputs.add(new TransactionOutput(genesisTransaction.reciepient, genesisTransaction.value, genesisTransaction.transactionId)); //manually add the Transactions Output
		UTXOs.put(genesisTransaction.outputs.get(0).id, genesisTransaction.outputs.get(0)); //its important to store our first transaction in the UTXOs list.
		
		System.out.println("Creating and Mining Genesis block... ");
		Block genesis = new Block("0");
		genesis.addTransaction(genesisTransaction);
		addBlock(genesis);
		
		//testing
		Block block1 = new Block(genesis.hash);
		System.out.println("\nWalletA's balance is: " + walletA.getBalance());
		System.out.println("\nWalletA is Attempting to send funds (40) to WalletB...");
		block1.addTransaction(walletA.sendFunds(walletB.publicKey, 40f));
		addBlock(block1);
		System.out.println("\nWalletA's balance is: " + walletA.getBalance());
		System.out.println("WalletB's balance is: " + walletB.getBalance());
		
		Block block2 = new Block(block1.hash);
		System.out.println("\nWalletA Attempting to send more funds (1000) than it has...");
		block2.addTransaction(walletA.sendFunds(walletB.publicKey, 1000f));
		addBlock(block2);
		System.out.println("\nWalletA's balance is: " + walletA.getBalance());
		System.out.println("WalletB's balance is: " + walletB.getBalance());
		
		Block block3 = new Block(block2.hash);
		System.out.println("\nWalletB is Attempting to send funds (20) to WalletA...");
		block3.addTransaction(walletB.sendFunds( walletA.publicKey, 20));
		System.out.println("\nWalletA's balance is: " + walletA.getBalance());
		System.out.println("WalletB's balance is: " + walletB.getBalance());
		
		isChainValid();
		
	}
	
	public static Boolean isChainValid() {
		Block currentBlock; 
		Block previousBlock;
		String hashTarget = new String(new char[difficulty]).replace('\0', '0');
		HashMap<String,TransactionOutput> tempUTXOs = new HashMap<String,TransactionOutput>(); //a temporary working list of unspent transactions at a given block state.
		tempUTXOs.put(genesisTransaction.outputs.get(0).id, genesisTransaction.outputs.get(0));
		
		//loop through blockchain to check hashes:
		for(int i=1; i < blockchain.size(); i++) {
			
			currentBlock = blockchain.get(i);
			previousBlock = blockchain.get(i-1);
			//compare registered hash and calculated hash:
			if(!currentBlock.hash.equals(currentBlock.calculateHash()) ){
				System.out.println("#Current Hashes not equal");
				return false;
			}
			//compare previous hash and registered previous hash
			if(!previousBlock.hash.equals(currentBlock.previousHash) ) {
				System.out.println("#Previous Hashes not equal");
				return false;
			}
			//check if hash is solved
			if(!currentBlock.hash.substring( 0, difficulty).equals(hashTarget)) {
				System.out.println("#This block hasn't been mined");
				return false;
			}
			
			//loop thru blockchains transactions:
			TransactionOutput tempOutput;
			for(int t=0; t <currentBlock.transactions.size(); t++) {
				Transaction currentTransaction = currentBlock.transactions.get(t);
				
				if(!currentTransaction.verifiySignature()) {
					System.out.println("#Signature on Transaction(" + t + ") is Invalid");
					return false; 
				}
				if(currentTransaction.getInputsValue() != currentTransaction.getOutputsValue()) {
					System.out.println("#Inputs are note equal to outputs on Transaction(" + t + ")");
					return false; 
				}
				
				for(TransactionInput input: currentTransaction.inputs) {	
					tempOutput = tempUTXOs.get(input.transactionOutputId);
					
					if(tempOutput == null) {
						System.out.println("#Referenced input on Transaction(" + t + ") is Missing");
						return false;
					}
					
					if(input.UTXO.value != tempOutput.value) {
						System.out.println("#Referenced input Transaction(" + t + ") value is Invalid");
						return false;
					}
					
					tempUTXOs.remove(input.transactionOutputId);
				}
				
				for(TransactionOutput output: currentTransaction.outputs) {
					tempUTXOs.put(output.id, output);
				}
				
				if( currentTransaction.outputs.get(0).reciepient != currentTransaction.reciepient) {
					System.out.println("#Transaction(" + t + ") output reciepient is not who it should be");
					return false;
				}
				if( currentTransaction.outputs.get(1).reciepient != currentTransaction.sender) {
					System.out.println("#Transaction(" + t + ") output 'change' is not sender.");
					return false;
				}
				
			}
			
		}
		System.out.println("Blockchain is valid");
		return true;
	}
	
	public static void addBlock(Block newBlock) {
		newBlock.mineBlock(difficulty);
		blockchain.add(newBlock);
	}
}
```
æ‰“å°ï¼š

```java
Connected to the target VM, address: '127.0.0.1:57085', transport: 'socket'
Creating and Mining Genesis block... 
Transaction Successfully added to Block
Block Mined!!! : 000b5a7ca6bf07639122cb31e884996895a482c281dd89c203824f1e93a661bf

WalletA's balance is: 100.0

WalletA is Attempting to send funds (40) to WalletB...
Transaction Successfully added to Block
Block Mined!!! : 000c7f814357abfea86ad1b38ec1dc3afed2afc9107f2bacc933d8136bf34df0

WalletA's balance is: 60.0
WalletB's balance is: 40.0

WalletA Attempting to send more funds (1000) than it has...
#Not Enough funds to send transaction. Transaction Discarded.
Block Mined!!! : 000b3822fb7985db438712816727d4bc382926a1c4654062aad4071d9b9fad98

WalletA's balance is: 60.0
WalletB's balance is: 40.0

WalletB is Attempting to send funds (20) to WalletA...
Transaction Successfully added to Block

WalletA's balance is: 80.0
WalletB's balance is: 20.0
Blockchain is valid
```

ç°åœ¨é’±åŒ…èƒ½å¤Ÿå®‰å…¨åœ°åœ¨æ‚¨çš„åŒºå—é“¾ä¸Šå‘é€é‡‘é¢ï¼Œåªè¦ä»–ä»¬æœ‰é‡‘é¢å‘é€ã€‚è¿™æ„å‘³ç€ä½ æœ‰ä½ è‡ªå·±çš„æœ¬åœ°åŠ å¯†è´§å¸

### å¯ä»¥è¿›è¡Œäº¤æ˜“çš„åŒºå—é“¾


[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai03.gif](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai03.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai03.gif")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai03.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai03.gif")

ä½ å·²ç»æˆåŠŸåœ°åˆ›å»ºäº†è‡ªå·±çš„åŠ å¯†è´§å¸ã€‚ä½ çš„åŒºå—é“¾ï¼š

- å…è®¸ç”¨æˆ·åˆ›å»ºé’±åŒ…
- ä½¿ç”¨æ¤­åœ†æ›²çº¿åŠ å¯†æ–¹å¼ä¸ºé’±åŒ…æä¾›å…¬é’¥å’Œç§é’¥
- é€šè¿‡ä½¿ç”¨æ•°å­—ç­¾åç®—æ³•è¯æ˜æ‰€æœ‰æƒï¼Œç¡®ä¿èµ„é‡‘è½¬ç§»
- å…è®¸ç”¨æˆ·åœ¨åŒºå—é“¾ä¸Šè¿›è¡Œäº¤æ˜“

[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.gif](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.gif")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.gif "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/qukuai/qukuai04.gif")

åŸæ–‡é“¾æ¥ï¼š[Creating Your First Blockchain with Java. Part 2-Transactions](https://medium.com/programmers-blockchain/creating-your-first-blockchain-with-java-part-2-transactions-2cdac335e0ce)


## ä»£ç ä¸‹è½½ ##
ä»æˆ‘çš„ github ä¸­ä¸‹è½½ï¼Œ[https://github.com/longfeizheng/blockchain-java](https://github.com/longfeizheng/blockchain-java)

---
[![https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/wechat/xiaochengxu.png](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/wechat/xiaochengxu.png "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/wechat/xiaochengxu.png")](https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/wechat/xiaochengxu.png "https://raw.githubusercontent.com/longfeizheng/longfeizheng.github.io/master/images/wechat/xiaochengxu.png")

> ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨å¾®ä¿¡å°ç¨‹åº**javaæ¶æ„å¸ˆå†ç¨‹**
ä¸Šä¸‹ç­çš„è·¯ä¸Šæ— èŠå—ï¼Ÿè¿˜åœ¨çœ‹å°è¯´ã€æ–°é—»å—ï¼Ÿä¸çŸ¥é“æ€æ ·æé«˜è‡ªå·±çš„æŠ€æœ¯å—ï¼Ÿæ¥å§è¿™é‡Œæœ‰ä½ éœ€è¦çš„javaæ¶æ„æ–‡ç« ï¼Œ1.5w+çš„javaå·¥ç¨‹å¸ˆéƒ½åœ¨çœ‹ï¼Œä½ è¿˜åœ¨ç­‰ä»€ä¹ˆï¼Ÿ